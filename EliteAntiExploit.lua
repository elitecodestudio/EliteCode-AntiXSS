local bannedUsersFile = "banned_users.json"
local bannedUsers = {}

local function loadBannedUsers()
    local file = LoadResourceFile(GetCurrentResourceName(), bannedUsersFile)
    if file then
        bannedUsers = json.decode(file) or {}
    end
end

local function saveBannedUsers()
    SaveResourceFile(GetCurrentResourceName(), bannedUsersFile, json.encode(bannedUsers, { indent = true }), -1)
end

local function isMaliciousMessage(message)
    local lower = message:lower()
    local badPatterns = { "<script", "<img", "<meta", "url", "onerror", "onload" }
    for _, pattern in ipairs(badPatterns) do
        if lower:find(pattern, 1, true) then
            return true
        end
    end
    return false
end

local function banPlayer(src, reason)
    local identifiers = GetPlayerIdentifiers(src)
    local steamId = identifiers[1] or "unknown"

    if not bannedUsers[steamId] then
        bannedUsers[steamId] = {
            name = GetPlayerName(src),
            reason = reason,
            time = os.date("%Y-%m-%d %H:%M:%S")
        }
        TriggerEvent("WebhookSend", {
            name = name,
            steam = identifier,
            reason = "Attempted XSS injection",
            src = src
        })
        saveBannedUsers()
    end

    DropPlayer(src, "ðŸš« ØªÙ… Ø­Ø¸Ø±Ùƒ Ø¨Ø³Ø¨Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙƒÙˆØ§Ø¯ Ø®Ø¨ÙŠØ«Ø©.\nØ§Ù„Ø³Ø¨Ø¨: " .. reason)
end

AddEventHandler('chatMessage', function(src, name, msg)
    if isMaliciousMessage(msg) then
        CancelEvent()
        banPlayer(src, "XSS Exploit Try : " .. msg)
    end
end)

RegisterCommand("me", function(src, args, raw)
    local msg = table.concat(args, " ")
    if isMaliciousMessage(msg) then
        banPlayer(src, "XSS Exploit Try : " .. msg)
    end
end, false)

AddEventHandler("playerConnecting", function(name, setKickReason, deferrals)
    local src = source
    deferrals.defer()
    Wait(0)

    deferrals.update("[EC] Checking Your Ids")
    Wait(100)

    local identifiers = GetPlayerIdentifiers(src)
    local steamId = identifiers[1] or "unknown"

    loadBannedUsers()

    if bannedUsers[steamId] then
        deferrals.done("ðŸš« Ø£Ù†Øª Ù…Ø­Ø¸ÙˆØ±.\nØ§Ù„Ø³Ø¨Ø¨: " .. bannedUsers[steamId].reason)
        CancelEvent()
    else
        deferrals.done()
    end
end)
